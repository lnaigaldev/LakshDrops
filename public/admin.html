<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LakshDrops Admin</title>

<style>
body {
  background: #0b0f1a;
  color: white;
  font-family: system-ui;
  padding: 30px;
}
input, button {
  padding: 10px;
  border-radius: 6px;
  border: none;
}
button { cursor: pointer; }
.danger { background: #ef4444; color: white; }
.success { background: #22c55e; color: white; }
.login, .panel { max-width: 900px; margin: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border-bottom: 1px solid #333;
  padding: 10px;
  text-align: left;
}
</style>
</head>

<body>

<div class="login" id="login">
  <h2>üîê Admin Login</h2>
  <input id="adminEmail" type="email" placeholder="Admin email">
  <button onclick="login()">Login</button>
</div>

<div class="panel" id="panel" style="display:none">
  <h2>‚öôÔ∏è Admin Dashboard</h2>
  <span id="admin-greeting"></span>
  <button class="danger" onclick="logout()">Logout</button>

  <table>
    <thead>
      <tr>
        <th>File</th>
        <th>Uploader</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="table"></tbody>
  </table>
</div>

<script>
let ADMIN_EMAIL = "";
let files = [];

function login() {
  ADMIN_EMAIL = document.getElementById("adminEmail").value.trim();
  if (!ADMIN_EMAIL) return alert("Admin email required");
  sessionStorage.setItem("ADMIN_EMAIL", ADMIN_EMAIL);
  load();
}

function logout() {
  sessionStorage.removeItem("ADMIN_EMAIL");
  location.reload();
}

async function load() {
  ADMIN_EMAIL = sessionStorage.getItem("ADMIN_EMAIL");
  if (!ADMIN_EMAIL) return;

  document.getElementById("login").style.display = "none";
  document.getElementById("panel").style.display = "block";
  document.getElementById("admin-greeting").innerText = `Logged in as: ${ADMIN_EMAIL}`;

  const res = await fetch("/files");
  files = await res.json();
  render();
}

function render() {
  const table = document.getElementById("table");
  table.innerHTML = "";

  files.forEach(f => {
    table.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${f.uploader || "-"}</td>
        <td>${f.description || "-"}</td>
        <td>
          <button class="success" onclick="download('${f.id}','${f.name}')">‚¨á</button>
          <button class="danger" onclick="del('${f.id}')">üóë</button>
        </td>
      </tr>
    `;
  });
}

async function download(id, name) {
  const res = await fetch("/admin/download/" + id, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: ADMIN_EMAIL })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert(err.error || "Download failed");
    return;
  }

  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

async function del(id) {
  if (!confirm("Delete this file?")) return;

  const res = await fetch("/admin/delete/" + id, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: ADMIN_EMAIL })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert(err.error || "Delete failed");
    return;
  }

  files = files.filter(f => f.id !== id);
  render();
}

load();
</script>

</body>
</html>